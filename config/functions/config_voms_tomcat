##############################################################################
# Copyright (c) Members of the EGEE Collaboration. 2004. 
# See http://www.eu-egee.org/partners/ for details on the copyright 
# holders.  
#
# Licensed under the Apache License, Version 2.0 (the "License"); 
# you may not use this file except in compliance with the License. 
# You may obtain a copy of the License at 
#
#    http://www.apache.org/licenses/LICENSE-2.0 
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS 
# OF ANY KIND, either express or implied. 
# See the License for the specific language governing permissions and 
# limitations under the License.
##############################################################################
#
# NAME :        config_voms_tomcat
#
# DESCRIPTION : This function configures Tomcat for voms admin.
#
# AUTHORS :     Maria.Alandes.Pradillo@cern.ch
#
# NOTES :       
#
# YAIM MODULE:  glite-yaim-voms
#                 
##############################################################################

config_voms_tomcat_check () {

requires $1 CATALINA_HOME

}

config_voms_tomcat_setenv () {

yaimgridenv_set CATALINA_HOME ${CATALINA_HOME}

}

config_voms_tomcat () {

TOMCAT_CONFIG_DIR=/etc/tomcat5/


yaimlog DEBUG "Check if the tomcat user exists and abort if it does not"
id -u ${TOMCAT_USER} > /dev/null 2>&1
if [ $? != "0" ] ; then
  yaimlog ERROR "$TOMCAT_USER user does not exist!"
  yestr ${YEX_NOUSER}
  yaimlog ERROR "${YERRORSTR}"
  exit ${YEX_NOUSER}
fi


yaimlog DEBUG "Ensure permissions and ownerships are correct"
chown -R ${TOMCAT_USER}:${TOMCAT_USER} ${TOMCAT_CONFIG_DIR}


yaimlog DEBUG "Check if the CATALINA_HOME location exists"
if [ -f ${CATALINA_HOME} ]; then
  yaimlog ERROR "CATALINA_HOME location ${CATALINA_HOME} doesn't exist"
  yestr ${YEX_NOSUCHFILE}
  yaimlog ERROR "${YERRORSTR}"
  exit ${YEX_NOSUCHFILE}
fi

yaimlog DEBUG "Set up secure connector if keys exist"

if [ -f ${X509_HOST_CERT} ]; then
  cp -pf /etc/grid-security/hostcert.pem ${CATALINA_HOME}/conf
  chown ${TOMCAT_USER}:${TOMCAT_USER} ${CATALINA_HOME}/conf/hostcert.pem
  cp -pf /etc/grid-security/hostkey.pem ${CATALINA_HOME}/conf
  chown ${TOMCAT_USER}:${TOMCAT_USER} ${CATALINA_HOME}/conf/hostkey.pem
  mv ${TOMCAT_CONFIG_DIR}/server.xml ${TOMCAT_CONFIG_DIR}/server.xml.orig
    cat <<EOF >> ${TOMCAT_CONFIG_DIR}/server.xml
<Connector acceptCount="100"
clientAuth="true"
crlFiles="/etc/grid-security/certificates/*.r0"
debug="0" disableUploadTimeout="true"
enableLookups="true"
log4jConfFile="${CATALINA_HOME}/conf/log4j-trustmanager.properties"
maxSpareThreads="75"
maxThreads="1000"
minSpareThreads="25"
port="8443" maxPostSize="0"
sSLImplementation="org.glite.security.trustmanager.tomcat.TMSSLImplementation"
scheme="https" secure="true"
sslCAFiles="/etc/grid-security/certificates/*.0"
sslCertFile="$CATALINA_HOME/conf/hostcert.pem"
sslKey="$CATALINA_HOME/conf/hostkey.pem" sslProtocol="TLS"/>
EOF
else
  yaimlog ERROR "File ${X509_HOST_CERT} not found !"
  yestr ${YEX_NOSUCHFILE}
  yaimlog ERROR "${YERRORSTR}"
  exit ${YEX_NOSUCHFILE}
fi

yaimlog DEBUG "Configure Tomcat memory size"
MemSize=`free -m | awk '/^Mem/{if($2 <= 4096) printf "%i", $2/2; else print "2048";}'`
MemSize=${MemSize:-256}
CATALINA_OPTS=\"-Xmx${MemSize}M -server -Dsun.net.client.defaultReadTimeout=240000 -XX:MaxPermSize=256m\"

yaimlog DEBUG "Update Tomcat configuration file with CATALINA_OPTS"
mv -f ${TOMCAT_CONFIG_DIR}/tomcat5.conf ${TOMCAT_CONFIG_DIR}/tomcat5.conf.orig
cat ${TOMCAT_CONFIG_DIR}/tomcat5.conf.orig | sed -e "s#^CATALINA_OPTS=.*#CATALINA_OPTS=echo -e \"${CATALINA_OPTS}\"#" > ${TOMCAT_CONFIG_DIR}/tomcat5.conf

yaimlog DEBUG "Start Tomcat"
cron_job check-tomcat root "10 * * * * /etc/rc.d/init.d/tomcat5 start > /dev/null 2>&1"
/etc/rc.d/init.d/tomcat5 restart
/sbin/chkconfig --add tomcat5
/sbin/chkconfig tomcat5 on

}
